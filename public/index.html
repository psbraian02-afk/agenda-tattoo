<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>RichardTattoo ‚Äì Agenda</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  * { box-sizing: border-box; font-family: 'Inter', system-ui, 'Segoe UI', Arial; }
  body { margin:0; background:#e8e8e8; color:#222; height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .app { width:100%; max-width:900px; height:600px; background:#fff; border-radius:20px; box-shadow:0 15px 40px rgba(0,0,0,.1); padding:40px; position:relative; overflow:hidden; }
  .screen { position:absolute; inset:40px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; opacity:0; transform:translateY(20px); pointer-events:none; transition:.4s ease; }
  .screen.active { opacity:1; transform:translateY(0); pointer-events:auto; }
  h1,h2 { font-weight:600; margin:0; }
  .brand { font-size:42px; color:#222; }
  input, select { padding:12px 14px; border-radius:10px; border:1px solid #ccc; width:260px; font-size:15px; outline:none; transition:.3s ease; }
  input:focus, select:focus { border-color:#444; box-shadow:0 0 5px rgba(0,0,0,.1); }
  button { padding:12px 24px; border-radius:30px; border:none; background:linear-gradient(90deg,#ff4b2b,#ff416c); color:#fff; font-weight:500; cursor:pointer; transition:.3s ease; }
  button:hover { transform:scale(1.05); box-shadow:0 5px 15px rgba(0,0,0,.2); }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .grid { display:grid; grid-template-columns:repeat(7,1fr); gap:10px; }
  .nav { position:absolute; bottom:20px; right:20px; display:flex; gap:12px; }
  .social { display:flex; gap:16px; }
  .social-btn { width:50px; height:50px; border-radius:50%; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.25s ease; background:#fff; }
  .social-btn:hover { background:#ff416c; color:#fff; transform:scale(1.1); }
  .admin-list { width:100%; max-height:360px; overflow:auto; display:flex; flex-direction:column; gap:12px; }
  .admin-card { background:#fafafa; border-radius:12px; padding:15px; display:flex; justify-content:space-between; align-items:center; gap:12px; box-shadow:0 5px 15px rgba(0,0,0,.05); }
  .admin-card div { flex:1; }
  .admin-actions { display:flex; gap:10px; align-items:center; }
  .delete-btn { background:#ff4b2b; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; transition:.3s ease; }
  .delete-btn:hover { background:#ff1c00; }
  .save-btn { background:#28a745; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; transition:.3s ease; }
  .save-btn:hover { background:#1c7a31; }
  .time-input { width:70px; padding:5px; border-radius:6px; border:1px solid #ccc; text-align:center; outline:none; }
  img { border-radius:8px; border:1px solid #ddd; }

  /* === LOGO AGREGADO === */
  .home-logo {
    position:absolute;
    top:20px;
    left:20px;
  }
  .home-logo img {
    width:90px;
    height:auto;
    border-radius:12px;
    box-shadow:none;
  }
</style>
</head>

<body>
<div class="app">

  <div class="screen active" id="home">

    <!-- LOGO -->
    <div class="home-logo">
      <img src="logo.png" alt="Logo Richard Tattoo">
    </div>

    <h1 class="brand">RichardTattoo</h1>
    <button onclick="tryGoAgenda()">Reservar tatuaje</button>
    <button onclick="promptAdmin()">Panel tatuador</button>

    <div class="social">
      <div class="social-btn" onclick="openInsta()">IG</div>
      <div class="social-btn" onclick="openWhatsApp()">WA</div>
    </div>
  </div>

  <div class="screen" id="login">
    <h2>Para agendar necesit√°s tu WhatsApp</h2>
    <input id="phoneInput" placeholder="+598 9xxxxxxx">
    <button onclick="login()">Continuar</button>
    <div class="nav"><button onclick="go('home')">Volver</button></div>
  </div>

  <div class="screen" id="month">
    <h2>Eleg√≠ el mes ‚Äì <span id="yearLabel"></span></h2>
    <div class="times" id="months"></div>
    <div class="nav"><button onclick="go('home')">Volver</button></div>
  </div>

  <div class="screen" id="day">
    <h2>Eleg√≠ el d√≠a</h2>
    <div class="grid" id="days"></div>
    <div class="nav"><button onclick="go('month')">Volver</button></div>
  </div>

  <div class="screen" id="tattooDetails">
    <h2>Detalles del tatuaje</h2>
    <input type="file" id="tattooImage" accept="image/*">
    <input type="number" id="tattooSize" placeholder="Tama√±o en cm" min="1">
    <input type="text" id="tattooPlace" placeholder="Lugar del cuerpo">
    <select id="timeSlot">
      <option value="small">Peque√±o (1h)</option>
      <option value="medium">Mediano (2h)</option>
      <option value="large">Grande (3h)</option>
    </select>
    <button id="confirmBtn" onclick="confirmBooking()" disabled>Confirmar reserva</button>
    <div class="nav"><button onclick="go('day')">Volver</button></div>
  </div>

  <div class="screen" id="done">
    <h2>Reserva confirmada ‚úîÔ∏è</h2>
    <button onclick="go('home')">Volver al inicio</button>
  </div>

  <div class="screen" id="admin">
    <h2>Agenda del tatuador</h2>
    <div class="admin-list" id="adminList"></div>
    <div class="nav"><button onclick="go('home')">Volver</button></div>
  </div>

</div>

<script>
const SERVER_URL = "/api/bookings";
const DURATIONS = { small:1, medium:2, large:3 };
let selectedMonth, selectedDay;
let bookings = [];
let userPhone = localStorage.getItem("whatsapp");

function nowUY(){ return new Date(new Date().toLocaleString("en-US",{timeZone:"America/Montevideo"})); }
function openInsta(){ window.open("https://www.instagram.com/richardtattooartigas/","_blank"); }
function openWhatsApp(){ window.open("https://wa.me/59892528388","_blank"); }
function go(id){ document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active")); document.getElementById(id).classList.add("active"); }

function tryGoAgenda(){ userPhone ? go("month") : go("login"); }
function login(){
  const phone = document.getElementById("phoneInput").value.trim();
  if(phone.length < 6) return alert("N√∫mero inv√°lido");
  localStorage.setItem("whatsapp", phone);
  userPhone = phone;
  go("month");
}

const year = nowUY().getFullYear();
document.getElementById("yearLabel").textContent = year;
const MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const monthsEl = document.getElementById("months");
const daysEl = document.getElementById("days");
MONTHS.forEach((m,i)=>{
  const b = document.createElement("button");
  b.textContent = m;
  if(i < nowUY().getMonth()) b.disabled = true;
  b.onclick = ()=>{ selectedMonth=i; renderDays(); go('day'); };
  monthsEl.appendChild(b);
});
function renderDays(){
  daysEl.innerHTML="";
  const today = nowUY();
  const daysInMonth = new Date(year, selectedMonth+1, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year, selectedMonth, d);
    const b = document.createElement("button");
    b.textContent = d;
    if(date < new Date(today.getFullYear(),today.getMonth(),today.getDate())) b.disabled = true;
    b.onclick = ()=>{ selectedDay=d; enableConfirmButton(); go('tattooDetails'); };
    daysEl.appendChild(b);
  }
}

function enableConfirmButton(){
  const btn = document.getElementById("confirmBtn");
  const img = document.getElementById("tattooImage");
  const size = document.getElementById("tattooSize");
  const place = document.getElementById("tattooPlace");
  const timeSlot = document.getElementById("timeSlot");
  btn.disabled = !(img.files.length && size.value && place.value && timeSlot.value);
}
document.getElementById("tattooImage").addEventListener("change", enableConfirmButton);
document.getElementById("tattooSize").addEventListener("input", enableConfirmButton);
document.getElementById("tattooPlace").addEventListener("input", enableConfirmButton);
document.getElementById("timeSlot").addEventListener("change", enableConfirmButton);

async function confirmBooking(){
  const imgInput = document.getElementById("tattooImage");
  const size = document.getElementById("tattooSize").value;
  const place = document.getElementById("tattooPlace").value;
  const slot = document.getElementById("timeSlot").value;
  const duration = DURATIONS[slot];

  const reader = new FileReader();
  reader.onload = async function(e){
    const booking = {
      date:`${year}-${selectedMonth+1}-${selectedDay}`,
      start:9,
      end:9+duration,
      phone:userPhone,
      tattoo:{ image:e.target.result, size:size, place:place, slot:slot },
      createdAt:new Date().toISOString()
    };
    try {
      const res = await fetch(SERVER_URL, {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(booking)
      });
      if(!res.ok) throw new Error("No se pudo guardar la reserva");
      bookings.push(booking);
      go("done");
    } catch(err){ alert("Error al guardar la reserva: " + err.message); }
  };
  reader.readAsDataURL(imgInput.files[0]);
}

function promptAdmin(){
  const pass = prompt("Ingrese la contrase√±a del tatuador:");
  if(pass === "tattoo123"){ openAdmin(); } else alert("Contrase√±a incorrecta");
}

function openAdmin(){
  fetch(SERVER_URL).then(r=>r.json()).then(data=>{ bookings=data; renderAdmin(); go("admin"); }).catch(err=>console.error(err));
}

function renderAdmin(){
  const list = document.getElementById("adminList");
  list.innerHTML="";
  if(bookings.length===0){ list.innerHTML="<p>No hay reservas.</p>"; return; }

  bookings.forEach((res,index)=>{
    const clean=res.phone.replace(/\D/g,"");
    const div=document.createElement("div");
    div.className="admin-card";
    div.innerHTML=`
      <div>
        <strong>${res.date}</strong><br>
        üìè ${res.tattoo.size}cm - ${res.tattoo.place}<br>
        <img src="${res.tattoo.image}" width="80"><br>
        üì≤ ${res.phone}<br>
        Horario: <input class="time-input" type="text" value="${res.start || '9:00'}" onchange="updateTime(${index}, this.value)">
      </div>
      <div class="admin-actions">
        <button class="delete-btn" onclick="deleteBooking(${index})">üóëÔ∏è</button>
        <button onclick="window.open('https://wa.me/${clean}','_blank')">WA</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function deleteBooking(idx){
  const booking = bookings[idx];
  if(confirm("Eliminar reserva de "+booking.phone+"?")){
    fetch(`${SERVER_URL}/${booking.id}`,{method:'DELETE'})
      .then(()=>{ bookings.splice(idx,1); renderAdmin(); })
      .catch(err=>alert("No se pudo eliminar: "+err));
  }
}

function updateTime(idx,value){
  const booking = bookings[idx];
  booking.start=value;
  console.log("Horario actualizado:", value);
}

fetch(SERVER_URL).then(r=>r.json()).then(data=>bookings=data).catch(err=>console.error(err));
</script>
</body>
</html>
