<!DOCTYPE html> 
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>RichardTattoo ‚Äì Agenda</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --dark:#1f1f1f;
  --dark-2:#2b2b2b;
  --dark-3:#111;
  --light:#e6e6e6;
  --white:#f9f9f9;
  --yellow:#f2c94c;
  --yellow-hover:#d4aa2a;
  --border:#3a3a3a;
}

*{ box-sizing:border-box; font-family:'Inter',system-ui,'Segoe UI',Arial; }

body{
  margin:0;
  background:var(--dark);
  color:var(--white);
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.app{
  width:100%;
  max-width:900px;
  height:600px;
  background:var(--dark-2);
  border-radius:22px;
  box-shadow:0 25px 60px rgba(0,0,0,.7);
  padding:40px;
  position:relative;
  overflow:hidden;
}

.screen{
  position:absolute;
  inset:40px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:20px;
  opacity:0;
  transform:translateY(20px);
  pointer-events:none;
  transition:.4s ease;
}

.screen.active{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
}

h1,h2{ font-weight:600; margin:0; letter-spacing:.5px; }
.brand{ font-size:42px; color:var(--yellow); }

input,select{
  padding:12px 14px; border-radius:12px; border:1px solid var(--border);
  width:260px; font-size:15px; background:var(--dark-3); color:var(--white); outline:none;
}

button{
  padding:12px 28px; border-radius:30px; border:none;
  background:var(--yellow); color:#111; font-weight:600;
  cursor:pointer; transition:.3s ease;
}

button:hover{ background:var(--yellow-hover); transform:translateY(-2px); }
button:disabled{ opacity:.4; cursor:not-allowed; background:#555; color:#888; }

.grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:10px; }
.grid button{ padding:10px 0; border-radius:10px; }

.nav{ position:absolute; bottom:20px; right:20px; }

.admin-list{ width:100%; max-height:360px; overflow:auto; display:flex; flex-direction:column; gap:14px; }
.admin-card{ background:var(--dark-3); border-radius:14px; padding:16px; display:flex; justify-content:space-between; align-items:center; }

.tattoo-options, .body-zones{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:20px; width:100%; max-height:300px; overflow-y:auto;
}
.tattoo-card, .zone-card{
  background:var(--dark-3); border-radius:14px; padding:15px; text-align:center;
  display:flex; flex-direction:column; align-items:center; gap:8px;
}
.tattoo-card img, .zone-card img{ width:70px; height:70px; object-fit:cover; border-radius:8px; }

#hoursGrid{ display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-top:10px; }

.location-box {
  background: rgba(242,201,76, 0.1); border-left: 4px solid var(--yellow);
  padding: 10px 15px; border-radius: 8px; font-size: 14px; margin: 10px 0;
}
</style>
</head>
<body>

<div class="app">
  <div class="screen active" id="home">
    <h1 class="brand">RichardTattoo</h1>
    <button onclick="tryGoAgenda()">Reservar Turno</button>
    <button onclick="promptAdmin()">Panel Admin</button>
  </div>

  <div class="screen" id="login">
    <h2>Tu WhatsApp</h2>
    <input id="phoneInput" placeholder="+598 9xxxxxxx">
    <button onclick="login()">Continuar</button>
    <div class="nav"><button onclick="go('home')">Volver</button></div>
  </div>

  <div class="screen" id="month">
    <h2>Mes <span id="yearLabel"></span></h2>
    <div id="months" class="grid"></div>
    <div class="nav"><button onclick="go('home')">Volver</button></div>
  </div>

  <div class="screen" id="day">
    <h2>D√≠a</h2>
    <div id="days" class="grid"></div>
    <div class="nav"><button onclick="go('month')">Volver</button></div>
  </div>

  <div class="screen" id="tattooDetails">
    <h2>Tama√±o / Proyecto</h2>
    <div class="tattoo-options" id="tattooOptions"></div>
    <div class="nav"><button onclick="go('day')">Volver</button></div>
  </div>

  <div class="screen" id="zoneSelection">
    <h2>Zona del cuerpo</h2>
    <div class="body-zones" id="zoneOptions"></div>
    <div class="nav"><button onclick="go('tattooDetails')">Volver</button></div>
  </div>

  <div class="screen" id="hourSelection">
    <h2>Hora disponible</h2>
    <div id="hoursGrid"></div>
    <div class="nav"><button onclick="goBackFromHours()">Volver</button></div>
  </div>

  <div class="screen" id="imageUploadScreen">
    <h2>Resumen</h2>
    <input type="file" id="userTattooImage" accept="image/*">
    <img id="userTattooPreview" style="display:none; width:100px;">
    <p id="userTattooInfo"></p>
    <div class="location-box">üìç Cerro Ejido, Calle 2, Casa N¬∞ 140.</div>
    <button id="confirmBtn" onclick="confirmBooking()" disabled>Confirmar reserva</button>
    <div class="nav"><button onclick="go('hourSelection')">Volver</button></div>
  </div>

  <div class="screen" id="done">
    <h2>¬°Reservado! ‚úîÔ∏è</h2>
    <button onclick="go('home')">Inicio</button>
  </div>
</div>

<script>
const SERVER_URL="/api/bookings";
const DURATIONS={ "muy-peque√±o":0.5, small:1, medium:2, large:3, "muy-grande":4, "manga-brazo":6, "espalda-completa":8 };
let selectedMonth, selectedDay, selectedTattoo, selectedHour, selectedZone, userPhone=localStorage.getItem("whatsapp");
let bookings=[];

function nowUY(){ return new Date(new Date().toLocaleString("en-US",{timeZone:"America/Montevideo"})); }
function go(id){ document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active")); document.getElementById(id).classList.add("active"); }
function tryGoAgenda(){ userPhone?go("month"):go("login"); }
function login(){ const p=document.getElementById("phoneInput").value; if(p.length>5){ localStorage.setItem("whatsapp",p); userPhone=p; go("month"); } }

// --- MESES Y DIAS ---
const year=nowUY().getFullYear();
const MONTHS=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
MONTHS.forEach((m,i)=>{
  const b=document.createElement("button"); b.textContent=m;
  if(i < nowUY().getMonth()) b.disabled=true;
  b.onclick=()=>{ selectedMonth=i; renderDays(); go('day'); };
  document.getElementById("months").appendChild(b);
});

function renderDays(){
  const daysEl=document.getElementById("days"); daysEl.innerHTML="";
  const daysInMonth=new Date(year,selectedMonth+1,0).getDate();
  for(let d=1;d<=daysInMonth;d++){
    const b=document.createElement("button"); b.textContent=d;
    const date=new Date(year,selectedMonth,d);
    if(date < nowUY().setHours(0,0,0,0)) b.disabled=true;
    b.onclick=()=>{ selectedDay=d; renderTattooOptions(); go("tattooDetails"); };
    daysEl.appendChild(b);
  }
}

// --- TAMA√ëOS Y LOGICA DE SALTO ---
const TATTOO_SIZES=[
  { id:"muy-peque√±o", label:"Muy peque√±o", price:"$500", img:"1.png" },
  { id:"small", label:"Peque√±o", price:"$1000", img:"2.png" },
  { id:"medium", label:"Mediano", price:"$2000", img:"3.png" },
  { id:"large", label:"Grande", price:"$3000", img:"4.png" },
  { id:"muy-grande", label:"Pieza Mayor", price:"$4000", img:"5.png" },
  { id:"manga-brazo", label:"Manga Completa", price:"$10000", img:"6.png" },
  { id:"espalda-completa", label:"Espalda Completa", price:"$15000", img:"7.png" }
];

function renderTattooOptions(){
  const container=document.getElementById("tattooOptions"); container.innerHTML="";
  TATTOO_SIZES.forEach(t=>{
    const card=document.createElement("div"); card.className="tattoo-card";
    card.innerHTML=`<img src="${t.img}"><strong>${t.label}</strong><p>${t.price}</p><button onclick="selectTattoo('${t.id}')">Elegir</button>`;
    container.appendChild(card);
  });
}

function selectTattoo(id){
  selectedTattoo = TATTOO_SIZES.find(t=>t.id===id);
  // LOGICA DE SALTO: Si es manga o espalda, no pregunta zona
  if(id === "manga-brazo" || id === "espalda-completa"){
    selectedZone = { label: selectedTattoo.label }; // La zona es el proyecto mismo
    renderHours();
    go("hourSelection");
  } else {
    renderZones();
    go("zoneSelection");
  }
}

function goBackFromHours(){
  if(selectedTattoo.id === "manga-brazo" || selectedTattoo.id === "espalda-completa") go("tattooDetails");
  else go("zoneSelection");
}

const BODY_ZONES=[ {id:"brazo", label:"Brazo", img:"z1.png"}, {id:"pierna", label:"Pierna", img:"z2.png"}, {id:"pecho", label:"Pecho", img:"z3.png"} ];
function renderZones(){
  const container=document.getElementById("zoneOptions"); container.innerHTML="";
  BODY_ZONES.forEach(z=>{
    const card=document.createElement("div"); card.className="zone-card";
    card.innerHTML=`<img src="${z.img}"><button onclick="selectZone('${z.id}')">${z.label}</button>`;
    container.appendChild(card);
  });
}
function selectZone(id){ selectedZone=BODY_ZONES.find(z=>z.id===id); renderHours(); go("hourSelection"); }

// --- CORRECCI√ìN BUG HORARIOS ---
function renderHours(){
  const grid=document.getElementById("hoursGrid"); grid.innerHTML="";
  const duration = DURATIONS[selectedTattoo.id];
  const now = nowUY();
  const isToday = (selectedDay === now.getDate() && selectedMonth === now.getMonth());

  for(let h=9; h<=21; h++){
    if(h === 12) continue; // Almuerzo
    
    let btn=document.createElement("button");
    btn.textContent=h+":00";
    let isBlocked = false;

    // 1. Bloqueo si ya pas√≥ la hora hoy
    if(isToday && h <= now.getHours()) isBlocked = true;

    // 2. Bloqueo si el tatuaje no termina antes de las 22:00
    if(h + duration > 22) isBlocked = true;

    // 3. Bloqueo por choque con otros turnos
    if(!isBlocked){
      bookings.forEach(b => {
        const bd = b.date.split("-"); // yyyy-mm-dd
        if(parseInt(bd[2])===selectedDay && parseInt(bd[1])===(selectedMonth+1)){
          const bStart = parseFloat(b.start);
          const bEnd = parseFloat(b.end);
          // Un turno choca si: Su inicio est√° dentro de otro O su fin pisa otro O envuelve a otro
          if( (h >= bStart && h < bEnd) || (h + duration > bStart && h + duration <= bEnd) || (h <= bStart && h + duration >= bEnd) ){
            isBlocked = true;
          }
        }
      });
    }

    btn.disabled = isBlocked;
    btn.onclick = () => { selectedHour=h; go("imageUploadScreen"); };
    grid.appendChild(btn);
  }
}

// --- CONFIRMACI√ìN ---
document.getElementById("userTattooImage").onchange = e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e2 => {
      document.getElementById("userTattooPreview").src = e2.target.result;
      document.getElementById("userTattooPreview").style.display="block";
      document.getElementById("userTattooInfo").innerHTML = `Reserva para el ${selectedDay}/${selectedMonth+1} a las ${selectedHour}:00hs.`;
      document.getElementById("confirmBtn").disabled = false;
    };
    reader.readAsDataURL(file);
  }
};

async function confirmBooking(){
  const duration = DURATIONS[selectedTattoo.id];
  const data = {
    date: `${year}-${selectedMonth+1}-${selectedDay}`,
    start: selectedHour, end: selectedHour + duration,
    phone: userPhone,
    tattoo: { size: selectedTattoo.label, zone: selectedZone.label, image: document.getElementById("userTattooPreview").src }
  };
  // Aqu√≠ ir√≠a el fetch real al servidor
  console.log("Guardando:", data);
  bookings.push(data);
  go("done");
}

function promptAdmin(){ if(prompt("Pass:")==="richard7392") go("home"); }
</script>
</body>
</html>